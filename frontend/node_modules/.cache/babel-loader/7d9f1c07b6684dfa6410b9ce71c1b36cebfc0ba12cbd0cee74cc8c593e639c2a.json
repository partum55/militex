{"ast":null,"code":"import React,{createContext,useState,useEffect,useContext,useCallback}from'react';import AuthService from'../services/auth.service';import{jsx as _jsx}from\"react/jsx-runtime\";const AuthContext=/*#__PURE__*/createContext(null);export function useAuth(){return useContext(AuthContext);}export const AuthProvider=_ref=>{let{children}=_ref;const[currentUser,setCurrentUser]=useState(null);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[isAuthenticated,setIsAuthenticated]=useState(false);const login=useCallback(async userData=>{setCurrentUser(userData);setIsAuthenticated(true);setError(null);},[]);useEffect(()=>{const initAuth=async()=>{try{setLoading(true);setError(null);if(AuthService.isAuthenticated()){console.log(\"Valid token found, getting user data\");try{const userData=await AuthService.getCurrentUser();setCurrentUser(userData);setIsAuthenticated(true);}catch(userError){console.error('Error fetching user data:',userError);try{const newToken=await AuthService.refreshToken();if(newToken){const userData=await AuthService.getCurrentUser();setCurrentUser(userData);setIsAuthenticated(true);}else{throw new Error(\"Token refresh failed\");}}catch(refreshError){console.error('Token refresh failed:',refreshError);AuthService.logout();setCurrentUser(null);setIsAuthenticated(false);}}}else{console.log(\"No valid token found\");try{const newToken=await AuthService.refreshToken();if(newToken){const userData=await AuthService.getCurrentUser();setCurrentUser(userData);setIsAuthenticated(true);}}catch(refreshError){console.log(\"Token refresh failed, logging out\");AuthService.logout();setCurrentUser(null);setIsAuthenticated(false);}}}catch(err){console.error('Authentication initialization error:',err);AuthService.logout();setCurrentUser(null);setIsAuthenticated(false);setError(err);}finally{setLoading(false);}};initAuth();},[]);const register=async userData=>{try{setLoading(true);setError(null);const response=await AuthService.register(userData);return response.data;}catch(err){var _err$response;console.error('Registration error:',err);setError(((_err$response=err.response)===null||_err$response===void 0?void 0:_err$response.data)||'Failed to register. Please try again.');throw err;}finally{setLoading(false);}};// Logout function\nconst logout=useCallback(()=>{AuthService.logout();setCurrentUser(null);setIsAuthenticated(false);// Force a page reload to clear any remaining state\nwindow.location.href='/';},[]);const updateUserProfile=async updatedData=>{try{setLoading(true);setError(null);const response=await AuthService.updateProfile(updatedData);setCurrentUser(response);return response;}catch(err){var _err$response2;console.error('Profile update error:',err);setError(((_err$response2=err.response)===null||_err$response2===void 0?void 0:_err$response2.data)||'Failed to update profile. Please try again.');throw err;}finally{setLoading(false);}};useEffect(()=>{const checkTokenInterval=setInterval(()=>{if(isAuthenticated&&!AuthService.isAuthenticated()){// Token expired, try to refresh\nAuthService.refreshToken().then(()=>{// Refresh successful, update user info\nAuthService.getCurrentUser().then(userData=>{setCurrentUser(userData);}).catch(err=>{console.error('Failed to get current user after token refresh:',err);logout();});}).catch(()=>{// Refresh failed, logout\nlogout();});}},5*60*1000);// 5 minutes\nreturn()=>{clearInterval(checkTokenInterval);};},[isAuthenticated,logout]);const value={currentUser,loading,error,isAuthenticated,login,register,logout,updateUserProfile};return/*#__PURE__*/_jsx(AuthContext.Provider,{value:value,children:children});};export default AuthContext;","map":{"version":3,"names":["React","createContext","useState","useEffect","useContext","useCallback","AuthService","jsx","_jsx","AuthContext","useAuth","AuthProvider","_ref","children","currentUser","setCurrentUser","loading","setLoading","error","setError","isAuthenticated","setIsAuthenticated","login","userData","initAuth","console","log","getCurrentUser","userError","newToken","refreshToken","Error","refreshError","logout","err","register","response","data","_err$response","window","location","href","updateUserProfile","updatedData","updateProfile","_err$response2","checkTokenInterval","setInterval","then","catch","clearInterval","value","Provider"],"sources":["C:/Users/bogda/Pyton programs/Web application OP/MILITEX/militex/frontend/src/contexts/AuthContext.js"],"sourcesContent":["import React, { createContext, useState, useEffect, useContext, useCallback } from 'react';\r\nimport AuthService from '../services/auth.service';\r\n\r\nconst AuthContext = createContext(null);\r\n\r\nexport function useAuth() {\r\n  return useContext(AuthContext);\r\n}\r\n\r\nexport const AuthProvider = ({ children }) => {\r\n  const [currentUser, setCurrentUser] = useState(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState(null);\r\n  const [isAuthenticated, setIsAuthenticated] = useState(false);\r\n\r\n  const login = useCallback(async (userData) => {\r\n    setCurrentUser(userData);\r\n    setIsAuthenticated(true);\r\n    setError(null);\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    const initAuth = async () => {\r\n      try {\r\n        setLoading(true);\r\n        setError(null);\r\n\r\n        if (AuthService.isAuthenticated()) {\r\n          console.log(\"Valid token found, getting user data\");\r\n          try {\r\n\r\n            const userData = await AuthService.getCurrentUser();\r\n            setCurrentUser(userData);\r\n            setIsAuthenticated(true);\r\n          } catch (userError) {\r\n            console.error('Error fetching user data:', userError);\r\n\r\n            try {\r\n              const newToken = await AuthService.refreshToken();\r\n              if (newToken) {\r\n                const userData = await AuthService.getCurrentUser();\r\n                setCurrentUser(userData);\r\n                setIsAuthenticated(true);\r\n              } else {\r\n                throw new Error(\"Token refresh failed\");\r\n              }\r\n            } catch (refreshError) {\r\n              console.error('Token refresh failed:', refreshError);\r\n              AuthService.logout();\r\n              setCurrentUser(null);\r\n              setIsAuthenticated(false);\r\n            }\r\n          }\r\n        } else {\r\n          console.log(\"No valid token found\");\r\n          try {\r\n            const newToken = await AuthService.refreshToken();\r\n            if (newToken) {\r\n              const userData = await AuthService.getCurrentUser();\r\n              setCurrentUser(userData);\r\n              setIsAuthenticated(true);\r\n            }\r\n          } catch (refreshError) {\r\n            console.log(\"Token refresh failed, logging out\");\r\n            AuthService.logout();\r\n            setCurrentUser(null);\r\n            setIsAuthenticated(false);\r\n          }\r\n        }\r\n      } catch (err) {\r\n        console.error('Authentication initialization error:', err);\r\n        AuthService.logout();\r\n        setCurrentUser(null);\r\n        setIsAuthenticated(false);\r\n        setError(err);\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    initAuth();\r\n  }, []);\r\n\r\n  const register = async (userData) => {\r\n    try {\r\n      setLoading(true);\r\n      setError(null);\r\n\r\n      const response = await AuthService.register(userData);\r\n      return response.data;\r\n    } catch (err) {\r\n      console.error('Registration error:', err);\r\n      setError(err.response?.data || 'Failed to register. Please try again.');\r\n      throw err;\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Logout function\r\n  const logout = useCallback(() => {\r\n    AuthService.logout();\r\n    setCurrentUser(null);\r\n    setIsAuthenticated(false);\r\n    // Force a page reload to clear any remaining state\r\n    window.location.href = '/';\r\n  }, []);\r\n\r\n  const updateUserProfile = async (updatedData) => {\r\n    try {\r\n      setLoading(true);\r\n      setError(null);\r\n\r\n      const response = await AuthService.updateProfile(updatedData);\r\n      setCurrentUser(response);\r\n\r\n      return response;\r\n    } catch (err) {\r\n      console.error('Profile update error:', err);\r\n      setError(err.response?.data || 'Failed to update profile. Please try again.');\r\n      throw err;\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    const checkTokenInterval = setInterval(() => {\r\n      if (isAuthenticated && !AuthService.isAuthenticated()) {\r\n        // Token expired, try to refresh\r\n        AuthService.refreshToken()\r\n          .then(() => {\r\n            // Refresh successful, update user info\r\n            AuthService.getCurrentUser()\r\n              .then(userData => {\r\n                setCurrentUser(userData);\r\n              })\r\n              .catch(err => {\r\n                console.error('Failed to get current user after token refresh:', err);\r\n                logout();\r\n              });\r\n          })\r\n          .catch(() => {\r\n            // Refresh failed, logout\r\n            logout();\r\n          });\r\n      }\r\n    }, 5 * 60 * 1000); // 5 minutes\r\n\r\n    return () => {\r\n      clearInterval(checkTokenInterval);\r\n    };\r\n  }, [isAuthenticated, logout]);\r\n\r\n  const value = {\r\n    currentUser,\r\n    loading,\r\n    error,\r\n    isAuthenticated,\r\n    login,\r\n    register,\r\n    logout,\r\n    updateUserProfile\r\n  };\r\n\r\n  return (\r\n    <AuthContext.Provider value={value}>\r\n      {children}\r\n    </AuthContext.Provider>\r\n  );\r\n};\r\n\r\nexport default AuthContext;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}