{"ast":null,"code":"import axios from'axios';// Create an axios instance for API calls\nconst api=axios.create({baseURL:'/api/',// Use relative URL\nheaders:{'Content-Type':'application/json'},withCredentials:true// Important for cookies\n});// Load token from localStorage on startup\nconst token=localStorage.getItem('militex_token');if(token){api.defaults.headers.common['Authorization']=`Bearer ${token}`;}// Add logging for debugging API requests\napi.interceptors.request.use(config=>{var _config$method;console.log(`API Request: ${(_config$method=config.method)===null||_config$method===void 0?void 0:_config$method.toUpperCase()} ${config.url}`,config.params||{});// Check token before each request\nconst token=localStorage.getItem('militex_token');if(token){config.headers['Authorization']=`Bearer ${token}`;}return config;},error=>{console.error('API Request Error:',error);return Promise.reject(error);});// Response interceptor for token refresh and error handling\napi.interceptors.response.use(response=>{// Optional: Log successful responses\n// console.log('API Response:', response.data);\nreturn response;},async error=>{var _error$response,_error$response2;// Log the error for debugging\nconsole.error('API Error:',((_error$response=error.response)===null||_error$response===void 0?void 0:_error$response.data)||error.message);const originalRequest=error.config;// If error is 401 and we haven't tried refreshing yet\nif(((_error$response2=error.response)===null||_error$response2===void 0?void 0:_error$response2.status)===401&&!originalRequest._retry){originalRequest._retry=true;try{console.log('Attempting token refresh...');const refreshToken=localStorage.getItem('militex_refresh_token');if(!refreshToken){throw new Error('No refresh token available');}const response=await axios.post('/api/token/refresh/',{refresh:refreshToken},{withCredentials:true// Ensure cookies are sent with this request too\n});if(response.data.access){console.log('Token refresh successful');localStorage.setItem('militex_token',response.data.access);api.defaults.headers.common['Authorization']=`Bearer ${response.data.access}`;// Update the authorization header in the original request\noriginalRequest.headers['Authorization']=`Bearer ${response.data.access}`;// Retry the original request\nreturn axios(originalRequest);}else{throw new Error('Access token not received');}}catch(refreshError){console.error('Token refresh failed:',refreshError);// If refresh fails, clear tokens and redirect to login\nlocalStorage.removeItem('militex_token');localStorage.removeItem('militex_refresh_token');localStorage.removeItem('militex_user');// If we're not already on the login page, redirect\nif(!window.location.pathname.includes('/login')){// Add a small delay before redirecting\nsetTimeout(()=>{window.location.href='/login';},100);}return Promise.reject(refreshError);}}return Promise.reject(error);});// Export the api instance\nexport default api;","map":{"version":3,"names":["axios","api","create","baseURL","headers","withCredentials","token","localStorage","getItem","defaults","common","interceptors","request","use","config","_config$method","console","log","method","toUpperCase","url","params","error","Promise","reject","response","_error$response","_error$response2","data","message","originalRequest","status","_retry","refreshToken","Error","post","refresh","access","setItem","refreshError","removeItem","window","location","pathname","includes","setTimeout","href"],"sources":["C:/Users/bogda/Pyton programs/Web application OP/MILITEX/militex/frontend/src/services/api.js"],"sourcesContent":["import axios from 'axios';\r\n\r\n// Create an axios instance for API calls\r\nconst api = axios.create({\r\n  baseURL: '/api/',  // Use relative URL\r\n  headers: {\r\n    'Content-Type': 'application/json',\r\n  },\r\n  withCredentials: true, // Important for cookies\r\n});\r\n\r\n// Load token from localStorage on startup\r\nconst token = localStorage.getItem('militex_token');\r\nif (token) {\r\n  api.defaults.headers.common['Authorization'] = `Bearer ${token}`;\r\n}\r\n\r\n// Add logging for debugging API requests\r\napi.interceptors.request.use(\r\n  (config) => {\r\n    console.log(`API Request: ${config.method?.toUpperCase()} ${config.url}`, config.params || {});\r\n\r\n    // Check token before each request\r\n    const token = localStorage.getItem('militex_token');\r\n    if (token) {\r\n      config.headers['Authorization'] = `Bearer ${token}`;\r\n    }\r\n    return config;\r\n  },\r\n  (error) => {\r\n    console.error('API Request Error:', error);\r\n    return Promise.reject(error);\r\n  }\r\n);\r\n\r\n// Response interceptor for token refresh and error handling\r\napi.interceptors.response.use(\r\n  (response) => {\r\n    // Optional: Log successful responses\r\n    // console.log('API Response:', response.data);\r\n    return response;\r\n  },\r\n  async (error) => {\r\n    // Log the error for debugging\r\n    console.error('API Error:', error.response?.data || error.message);\r\n\r\n    const originalRequest = error.config;\r\n\r\n    // If error is 401 and we haven't tried refreshing yet\r\n    if (error.response?.status === 401 && !originalRequest._retry) {\r\n      originalRequest._retry = true;\r\n\r\n      try {\r\n        console.log('Attempting token refresh...');\r\n        const refreshToken = localStorage.getItem('militex_refresh_token');\r\n\r\n        if (!refreshToken) {\r\n          throw new Error('No refresh token available');\r\n        }\r\n\r\n        const response = await axios.post('/api/token/refresh/', {\r\n          refresh: refreshToken\r\n        }, {\r\n          withCredentials: true // Ensure cookies are sent with this request too\r\n        });\r\n\r\n        if (response.data.access) {\r\n          console.log('Token refresh successful');\r\n          localStorage.setItem('militex_token', response.data.access);\r\n          api.defaults.headers.common['Authorization'] = `Bearer ${response.data.access}`;\r\n\r\n          // Update the authorization header in the original request\r\n          originalRequest.headers['Authorization'] = `Bearer ${response.data.access}`;\r\n\r\n          // Retry the original request\r\n          return axios(originalRequest);\r\n        } else {\r\n          throw new Error('Access token not received');\r\n        }\r\n      } catch (refreshError) {\r\n        console.error('Token refresh failed:', refreshError);\r\n\r\n        // If refresh fails, clear tokens and redirect to login\r\n        localStorage.removeItem('militex_token');\r\n        localStorage.removeItem('militex_refresh_token');\r\n        localStorage.removeItem('militex_user');\r\n\r\n        // If we're not already on the login page, redirect\r\n        if (!window.location.pathname.includes('/login')) {\r\n          // Add a small delay before redirecting\r\n          setTimeout(() => {\r\n            window.location.href = '/login';\r\n          }, 100);\r\n        }\r\n\r\n        return Promise.reject(refreshError);\r\n      }\r\n    }\r\n\r\n    return Promise.reject(error);\r\n  }\r\n);\r\n\r\n// Export the api instance\r\nexport default api;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}